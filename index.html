<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HABIT30 - Your 30 Day Habit Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat:400,700"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #6c757d;
        --background-color: #f4f6f9;
        --card-background: #ffffff;
        --sidebar-background: #f8f9fa;
        --mon-color: #3498db;
        --tue-color: #2ecc71;
        --wed-color: #e74c3c;
        --thu-color: #f39c12;
        --fri-color: #9b59b6;
        --sat-color: #1abc9c;
        --sun-color: #e84393;
      }

      body {
        background-color: var(--background-color);
        font-family: "Inter", sans-serif;
        color: #333;
        line-height: 1.6;
      }

      .app-container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 350px;
        background-color: var(--sidebar-background);
        padding: 30px 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .main-content {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        margin-left: 350px;
        width: calc(100% - 350px);
      }

      .habit-actions .habit-time {
        font-size: 0.9em;
        font-weight: bold;
        color: #666;
        margin-right: 10px;
      }

      .habit-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .habit-container {
        --i: 1; /* Add this line */
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px;
        background: #f9f9f9;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: all 0.3s ease;
        position: relative;
      }

      .habit-body {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
      }

      .habit-container.dragging,
      .dragging-mode .habit-container {
        width: 100%;
        height: 60px;
        padding: 10px;
        background-color: #f8f9fa;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        cursor: grabbing;
        transition: all 0.3s ease;
      }

      .habit-container.dragging {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }

      .habit-drag-handle {
        display: none;
        align-items: center;
        cursor: grab;
        padding-right: 10px;
      }

      .habit-container.dragging .habit-drag-handle,
      .dragging-mode .habit-container .habit-drag-handle {
        display: flex;
      }

      .habit-container.dragging .habit-header,
      .dragging-mode .habit-container .habit-header {
        display: flex;
        align-items: center;
        white-space: nowrap;
        overflow: hidden;
      }

      .habit-container.dragging .habit-header h5,
      .dragging-mode .habit-container .habit-header h5 {
        margin: 0;
        margin-right: 10px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .habit-container.dragging .habit-body,
      .dragging-mode .habit-container .habit-body {
        display: none;
      }

      .dragging-mode .habit-grid {
        grid-template-columns: 1fr;
      }

      .habit-actions {
        display: flex;
        align-items: center;
        margin-left: auto;
        margin-top: auto;
      }

      .habit-actions i {
        margin-left: 10px;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .habit-actions i:hover {
        transform: scale(1.2);
      }

      .habit-header {
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .habit-header h5 {
        margin: 0;
        font-weight: bold;
        font-size: 1.2em;
      }

      .habit-description {
        margin: 0 0 10px 0; /* Space below description */
        font-size: 0.9em;
        font-style: italic;
        color: #666;
        line-height: 1.4;
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .day-checkboxes {
        flex: 1; /* Take up available horizontal space */
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 10px 0;
      }

      .day-checkbox-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .day-label {
        font-size: 0.7em;
        margin-bottom: 3px;
        font-weight: bold;
      }

      .day-checkbox {
        flex: 0 0 auto;
        width: 30px;
        height: 30px;
        border: 2px solid var(--primary-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      /* Day Colors and Completed States */
      .mon {
        border-color: var(--mon-color);
      }
      .tue {
        border-color: var(--tue-color);
      }
      .wed {
        border-color: var(--wed-color);
      }
      .thu {
        border-color: var(--thu-color);
      }
      .fri {
        border-color: var(--fri-color);
      }
      .sat {
        border-color: var(--sat-color);
      }
      .sun {
        border-color: var(--sun-color);
      }

      .day-checkbox.completed {
        color: white;
        background-color: var(--primary-color);
      }

      .mon.completed {
        background-color: var(--mon-color);
      }
      .tue.completed {
        background-color: var(--tue-color);
      }
      .wed.completed {
        background-color: var(--wed-color);
      }
      .thu.completed {
        background-color: var(--thu-color);
      }
      .fri.completed {
        background-color: var(--fri-color);
      }
      .sat.completed {
        background-color: var(--sat-color);
      }
      .sun.completed {
        background-color: var(--sun-color);
      }

      .pdf-page {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, 1fr);
        grid-gap: 10px; /* Reduced gap */
        page-break-after: always;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }

      .export-button {
        position: relative;
        width: 200px;
        height: 50px;
        padding: 10px;
        background-color: #ffffff;
        border: 2px solid #1ecd97;
        border-radius: 50px;
        color: #1ecd97;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
      }

      .export-button .button-text {
        transition: all 0.3s ease;
      }

      .export-button .loading-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background-color: #1ecd97;
        transform: translate(-50%, -50%);
        opacity: 0;
        transition: all 0.3s ease;
      }

      .export-button .checkmark {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        opacity: 0;
        transform: translate(-50%, -50%) rotate(45deg);
        border-right: 3px solid white;
        border-bottom: 3px solid white;
        transition: all 0.3s ease;
      }

      .export-button.loading {
        width: 50px;
        border-radius: 50%;
      }

      .export-button.loading .button-text {
        opacity: 0;
      }

      .export-button.loading .loading-circle {
        width: 100%;
        height: 100%;
        opacity: 1;
      }

      .export-button.success .loading-circle {
        width: 100%;
        height: 100%;
        opacity: 1;
      }

      .export-button.success .checkmark {
        width: 20px;
        height: 30px;
        opacity: 1;
      }

      .export-button:hover {
        color: white;
        background: #1ecd97;
      }

      .export-button.onclic {
        width: 40px;
        border-color: #bbbbbb;
        border-width: 3px;
        font-size: 0;
        border-left-color: #1ecd97;
        animation: rotating 2s 0.25s linear infinite;
      }

      .export-button.validate {
        font-size: 13px;
        color: white;
        background: #1ecd97;
      }

      .progress-container {
        width: 100%;
        margin-top: 10px;
      }
      #daily-progress {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }
      #daily-progress-bar {
        width: 0%;
        height: 100%;
        background-color: red;
        transition: width 0.5s ease, background-color 0.5s ease;
      }
      .progress-info {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        font-size: 0.8em;
        color: #666;
      }

      /* Productivity Progress Bar */
      #productivity-progress {
        position: relative;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        margin-bottom: 10px;
      }

      #productivity-progress-bar {
        height: 100%;
        width: 0%; /* Dynamically updated */
        background: linear-gradient(
          to right,
          #ff3e3e,
          /* Lazy */ #ff9800,
          /* Struggling */ #ffc107,
          /* Developing */ #8bc34a,
          /* Difficult Points */ #4caf50,
          /* Productive */ #2196f3 /* Successful */
        );
        transition: width 0.5s ease;
      }

      /* Productivity Progress Bar Target Labels */
      .target-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        font-size: 0.75em;
        color: #666;
        position: relative;
      }

      .top-target {
        justify-content: center;
      }

      .target-labels-top {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        font-size: 0.75em;
        color: #666;
        position: relative;
        width: 106%;
      }

      .target-labels span {
        position: relative;
        white-space: nowrap;
      }
      .target-labels-top span {
        position: relative;
        white-space: nowrap;
        margin-left: 30px;
      }

      .target-labels span::before {
        content: "";
        position: absolute;
        top: -10px; /* Adjust to match the bar */
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 10px;
        background-color: #ccc; /* Marker color */
      }

      .target-labels-top span::before {
        content: "";
        position: absolute;
        bottom: -10px; /* Adjust to match the bar */
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 10px;
        background-color: #ccc; /* Marker color */
      }

      .donut-chart {
        position: relative;
        width: 60px;
        height: 60px;
        margin: 0 auto;
      }

      .donut-chart svg {
        transform: rotate(-90deg);
      }

      .donut-chart circle {
        fill: none;
        stroke-width: 4;
      }

      .donut-chart .background {
        stroke: #e0e0e0;
      }

      .donut-chart .progress {
        stroke: green; /* Initial color */
        transition: stroke 0.3s ease, stroke-dasharray 0.3s ease;
      }

      .donut-chart .center-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        color: #333;
      }

      @keyframes rotating {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Add these media queries to your existing <style> section, typically near the end of the existing media queries */
      @media (max-width: 480px) {
        .app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          position: static;
          height: auto;
          padding: 15px;
        }

        .main-content {
          margin-left: 0;
          width: 100%;
          padding: 10px;
        }

        .habit-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .habit-container {
          flex-direction: column;
        }

        .habit-header {
          flex-direction: column;
          align-items: flex-start;
          margin-bottom: 10px;
        }

        .habit-actions {
          width: 100%;
          justify-content: space-between;
          margin-top: 5px;
        }

        .day-checkboxes {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }

        .day-checkbox-wrapper {
          flex-direction: row;
          align-items: center;
          gap: 10px;
        }

        .day-label {
          margin-bottom: 0;
          margin-right: 5px;
        }

        .donut-chart {
          margin-top: 10px;
          align-self: center;
        }

        .export-button {
          width: 100%;
        }

        .progress-container {
          margin-top: 15px;
        }

        /* Adjust modal for mobile */
        .modal-dialog {
          margin: 1.75rem 0.5rem;
          max-width: none;
        }

        /* Reduce font sizes for better mobile readability */
        body {
          font-size: 14px;
        }

        .habit-header h5 {
          font-size: 1em;
        }

        .habit-description {
          font-size: 0.8em;
        }

        .habit-time {
          font-size: 0.8em;
        }
      }

      @media print {
        .pdf-export-container {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          grid-template-rows: repeat(2, 1fr);
          gap: 10px;
          padding: 10px;
          box-sizing: border-box;
          width: 100%;
          height: 100%;
        }

        .pdf-export-container .habit-container {
          border: 1px solid #e0e0e0;
          padding: 10px;
          display: flex;
          flex-direction: column;
          height: 100%;
          break-inside: avoid;
        }

        .pdf-export-container .habit-actions {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="sidebar">
        <div class="logo">
          <h1>HABIT30 <i class="bi bi-clipboard-check text-primary"></i></h1>
        </div>

        <div class="mb-4">
          <label class="form-label">Start Date</label>
          <input
            type="text"
            id="date-picker"
            class="form-control text-center"
            placeholder="Select Start Date"
          />
        </div>

        <div class="progress-container mb-4">
          <div id="daily-progress">
            <div id="daily-progress-bar"></div>
          </div>
          <div class="progress-info">
            <span id="hours-used">0h</span>
            <span id="hours-remaining">24h</span>
          </div>
        </div>

        <div class="progress-container mb-4">
          <div class="top-target">
            <div class="target-labels-top">
              <span>Struggling</span>

              <span>Difficult Points</span>

              <span>Successful</span>
            </div>
          </div>
          <div id="productivity-progress">
            <div id="productivity-progress-bar"></div>
            <!-- Target labels -->
          </div>
          <div class="target-labels">
            <span>Lazy</span>

            <span>Developing</span>

            <span>Productive</span>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Add New Habit</h5>
            <form id="habit-form">
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="habit-name"
                  placeholder="Habit Name"
                  required
                />
              </div>
              <div class="mb-3">
                <textarea
                  class="form-control"
                  id="habit-description"
                  placeholder="Enter a brief description (optional)"
                  rows="2"
                  style="font-size: 0.9em; font-style: italic"
                ></textarea>
              </div>
              <div class="mb-3">
                <label>Time Range</label>
                <div class="row">
                  <div class="col">
                    <input
                      type="time"
                      class="form-control"
                      id="start-time"
                      required
                    />
                  </div>
                  <div class="col">
                    <input
                      type="time"
                      class="form-control"
                      id="end-time"
                      required
                    />
                  </div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-plus-circle"></i> Add Habit
              </button>
            </form>
          </div>
        </div>

        <div class="text-center">
          <button id="export-pdf" class="export-button w-100">
            <span class="button-text">
              <i class="bi bi-file-earmark-pdf"></i> Export as PDF
            </span>
            <div class="loading-circle"></div>
            <div class="checkmark"></div>
          </button>
        </div>
      </div>

      <div class="main-content">
        <div id="habits-list" class="habit-grid"></div>
      </div>
    </div>
    <div class="modal fade" id="editHabitModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Habit</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-habit-form">
              <input type="hidden" id="edit-habit-id" />
              <div class="mb-3">
                <label class="form-label">Habit Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-habit-name"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  id="edit-habit-description"
                  rows="2"
                  style="font-size: 0.9em; font-style: italic"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Start Time</label>
                <input
                  type="time"
                  class="form-control"
                  id="edit-start-time"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">End Time</label>
                <input
                  type="time"
                  class="form-control"
                  id="edit-end-time"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="save-habit-changes"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      class HabitTracker {
        constructor() {
          this.habits = [];
          this.startDate = null;
          this.days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
          this.dayClasses = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
          this.initializeFlatpickr();
          this.initializeEventListeners();
          this.initializeDragAndDrop(); // Add this call
          this.loadHabits();
          this.draggingHabit = null;
        }

        // All previous methods remain the same as in the original code
        initializeFlatpickr() {
          flatpickr("#date-picker", {
            dateFormat: "Y-m-d",
            onChange: (selectedDates, dateStr) => {
              this.startDate = new Date(dateStr);
            },
          });
        }

        initializeEventListeners() {
          document
            .getElementById("habit-form")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              this.addHabit();
            });

          document
            .getElementById("export-pdf")
            .addEventListener("click", () => {
              this.exportToPDF();
            });
        }

        initializeDragAndDrop() {
          const habitsList = document.getElementById("habits-list");
          let draggingHabit = null;

          // Add this line to toggle the grid layout
          const toggleGridLayout = (isToDraggingMode) => {
            if (isToDraggingMode) {
              habitsList.classList.add("dragging-mode");
            } else {
              habitsList.classList.remove("dragging-mode");
            }
          };

          habitsList.addEventListener("mousedown", (e) => {
            const habitContainer = e.target.closest(".habit-container");
            const dragHandle = e.target.closest(".habit-drag-handle");

            if (dragHandle) {
              habitContainer.setAttribute("draggable", "true");

              // Dynamically set the --i and --stop properties
              const habitElements = [
                ...habitsList.querySelectorAll(".habit-container"),
              ];
              habitElements.forEach((el, index) => {
                el.style.setProperty("--i", index + 1);
                el.style.setProperty(
                  "--stop",
                  `calc(100% / ${habitElements.length} * ${index + 1})`
                );
              });
            }
          });

          habitsList.addEventListener("dragstart", (e) => {
            const habitContainer = e.target.closest(".habit-container");

            if (habitContainer) {
              draggingHabit = habitContainer;
              // Use setTimeout to allow for class addition after dragstart
              setTimeout(() => {
                habitContainer.classList.add("dragging");
                toggleGridLayout(true); // Toggle to 1 column

                // Set a width and height to prevent layout shift
                habitContainer.style.width = `${habitContainer.offsetWidth}px`;
                habitContainer.style.height = `${habitContainer.offsetHeight}px`;
              }, 0);

              // Required for Firefox
              e.dataTransfer.setData("text/plain", "");
            }
          });

          habitsList.addEventListener("dragend", (e) => {
            const habitContainer = e.target.closest(".habit-container");

            if (habitContainer) {
              habitContainer.classList.remove("dragging");
              toggleGridLayout(false); // Return to original layout

              // Reset inline styles
              habitContainer.style.width = "";
              habitContainer.style.height = "";

              draggingHabit = null;
              this.updateHabitOrder();
            }
          });

          habitsList.addEventListener("dragover", (e) => {
            e.preventDefault();
            const afterElement = this.getDragAfterElement(
              habitsList,
              e.clientY
            );

            if (draggingHabit) {
              if (afterElement == null) {
                habitsList.appendChild(draggingHabit);
              } else {
                habitsList.insertBefore(draggingHabit, afterElement);
              }
            }
          });
        }

        getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll(".habit-container:not(.dragging)"),
          ];

          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        }

        updateHabitOrder() {
          const habitElements = [
            ...document.querySelectorAll(".habit-container"),
          ];
          this.habits = habitElements.map((habitElement) => {
            const index = habitElement.getAttribute("data-habit-index");
            return this.habits[index];
          });

          // Update the --i and --stop properties after reordering
          habitElements.forEach((el, index) => {
            el.style.setProperty("--i", index + 1);
            el.style.setProperty(
              "--stop",
              `calc(100% / ${habitElements.length} * ${index + 1})`
            );
          });
          this.saveHabits();
        }

        updateDailyProgress() {
          // Calculate total hours used across all habits
          const totalHoursUsed = this.habits.reduce((total, habit) => {
            const startTime = new Date(`2000-01-01T${habit.startTime}`);
            const endTime = new Date(`2000-01-01T${habit.endTime}`);
            const hoursDiff = (endTime - startTime) / (1000 * 60 * 60);
            return total + hoursDiff;
          }, 0);

          // Productivity Progress Bar Calculation
          const totalCheckboxes = this.habits.reduce(
            (sum, habit) => sum + habit.days.length,
            0
          );
          const checkedCheckboxes = this.habits.reduce(
            (sum, habit) => sum + habit.days.filter((day) => day).length,
            0
          );

          const productivityPercentage =
            totalCheckboxes > 0
              ? (checkedCheckboxes / totalCheckboxes) * 100
              : 0;

          // Update the Productivity Progress Bar
          const productivityBar = document.getElementById(
            "productivity-progress-bar"
          );
          productivityBar.style.width = `${productivityPercentage}%`;

          // Color adjustment based on percentage
          if (productivityPercentage <= 20) {
            productivityBar.style.backgroundColor = "#ff3e3e"; // Lazy
          } else if (productivityPercentage <= 40) {
            productivityBar.style.backgroundColor = "#ff9800"; // Struggling
          } else if (productivityPercentage <= 60) {
            productivityBar.style.backgroundColor = "#ffc107"; // Developing
          } else if (productivityPercentage <= 80) {
            productivityBar.style.backgroundColor = "#8bc34a"; // Difficult Points
          } else if (productivityPercentage <= 99) {
            productivityBar.style.backgroundColor = "#4caf50"; // Productive
          } else {
            productivityBar.style.backgroundColor = "#2196f3"; // Successful
          }

          // Update progress bar
          const progressBar = document.getElementById("daily-progress-bar");
          const hoursUsedSpan = document.getElementById("hours-used");
          const hoursRemainingSpan = document.getElementById("hours-remaining");

          // Calculate percentage
          const progressPercentage = Math.min((totalHoursUsed / 24) * 100, 100);
          progressBar.style.width = `${progressPercentage}%`;

          // Color logic
          if (progressPercentage < 33) {
            progressBar.style.backgroundColor = "red";
          } else if (progressPercentage < 66) {
            progressBar.style.backgroundColor = "orange";
          } else {
            progressBar.style.backgroundColor = "green";
          }

          // Update text
          hoursUsedSpan.textContent = `${totalHoursUsed.toFixed(1)}h`;
          hoursRemainingSpan.textContent = `${(24 - totalHoursUsed).toFixed(
            1
          )}h`;
        }

        addHabit() {
          if (!this.startDate) {
            alert("Please select a start date first!");
            return;
          }

          const habitName = document.getElementById("habit-name").value;
          const description =
            document.getElementById("habit-description").value;
          const startTime = document.getElementById("start-time").value;
          const endTime = document.getElementById("end-time").value;

          const habit = {
            id: Date.now(),
            name: habitName,
            description: description || "", // Add description
            startTime: startTime,
            endTime: endTime,
            days: Array(30).fill(false),
          };

          this.habits.push(habit);
          this.saveHabits();
          this.renderHabits();
          this.resetForm();
          this.updateDailyProgress();
          this.updateDonutCharts();
        }

        renderHabits() {
          const habitsList = document.getElementById("habits-list");
          habitsList.innerHTML = "";

          this.habits.forEach((habit, index) => {
            const habitElement = document.createElement("div");
            habitElement.classList.add("habit-container");
            habitElement.setAttribute("data-habit-index", index);
            habitElement.setAttribute("draggable", "true");
            habitElement.setAttribute("data-habit-id", habit.id);
            habitElement.innerHTML = `
            <div class="habit-drag-handle" style="cursor: move; display: flex; align-items: center; padding-right: 10px;">
              <i class="bi bi-list"></i>
            </div>
            <div class="habit-header">
  <h5>${habit.name}</h5>
  <div class="habit-actions">
    <span class="habit-time">${habit.startTime} - ${habit.endTime}</span>
    <i class="bi bi-pencil-fill edit-habit me-2" data-id="${
      habit.id
    }" style="cursor: pointer; color: blue;"></i>
    <i class="bi bi-trash-fill delete-habit" data-id="${
      habit.id
    }" style="cursor: pointer; color: red;"></i>
  </div>
</div>
<p class="habit-description" style="font-size: 0.9em; font-style: italic; color: #666; margin-bottom: 10px;">
  ${habit.description || ""}
</p>

            <div class="habit-body">
              <div class="day-checkboxes">
                ${this.days
                  .map(
                    (day, dayIdx) => `
                    <div class="day-checkbox-wrapper">
                        <div class="day-label">${day}</div>
                        ${this.generateDayCheckboxes(habit, index, dayIdx)}
                    </div>
                `
                  )
                  .join("")}
              </div>
              <div class="donut-chart" data-habit-id="${habit.id}">
                <svg viewBox="0 0 36 36">
                    <circle class="background" cx="18" cy="18" r="15.915"></circle>
                    <circle class="progress" cx="18" cy="18" r="15.915" stroke-dasharray="0 100"></circle>
                </svg>
                <div class="center-text">0%</div>
              </div>
            </div>
          `;

            habitsList.appendChild(habitElement);
          });

          this.setupCheckboxListeners();
          this.setupHabitActionListeners();
          this.updateDailyProgress();
          this.updateDonutCharts();
        }

        generateDayCheckboxes(habit, habitIndex, dayOffset) {
          return Array(4)
            .fill()
            .map((_, i) => {
              const dayIndex = dayOffset + i * 7;
              return `
                                                  <div class="day-checkbox ${
                                                    this.dayClasses[dayOffset]
                                                  } ${
                habit.days[dayIndex] ? "completed" : ""
              }"
                                                       data-habit-index="${habitIndex}"
                                                       data-day-index="${dayIndex}"></div>
                                              `;
            })
            .join("");
        }

        setupCheckboxListeners() {
          document.querySelectorAll(".day-checkbox").forEach((checkbox) => {
            checkbox.addEventListener("click", (e) => {
              const habitIndex = e.target.getAttribute("data-habit-index");
              const dayIndex = e.target.getAttribute("data-day-index");

              this.habits[habitIndex].days[dayIndex] =
                !this.habits[habitIndex].days[dayIndex];
              e.target.classList.toggle("completed");
              this.saveHabits();

              // Update progress bars dynamically
              this.updateDailyProgress();
            });
          });
        }

        setupHabitActionListeners() {
          document.querySelectorAll(".delete-habit").forEach((deleteIcon) => {
            deleteIcon.addEventListener("click", (e) => {
              const habitId = e.target.getAttribute("data-id");
              this.habits = this.habits.filter((habit) => habit.id != habitId);
              this.saveHabits();
              this.renderHabits();
            });
          });

          document.querySelectorAll(".edit-habit").forEach((editIcon) => {
            editIcon.addEventListener("click", (e) => {
              // Find the specific habit to edit
              const habitId = e.target.getAttribute("data-id");
              const habit = this.habits.find((h) => h.id == habitId);

              // Populate modal form fields
              document.getElementById("edit-habit-id").value = habitId;
              document.getElementById("edit-habit-name").value = habit.name;
              document.getElementById("edit-habit-description").value =
                habit.description || "";
              document.getElementById("edit-start-time").value =
                habit.startTime;
              document.getElementById("edit-end-time").value = habit.endTime;

              // Show the modal
              const editModal = new bootstrap.Modal(
                document.getElementById("editHabitModal")
              );
              editModal.show();
            });
          });

          document
            .getElementById("save-habit-changes")
            .addEventListener("click", () => {
              // Find the habit being edited using the hidden input's ID
              const habitId = document.getElementById("edit-habit-id").value;
              const habit = this.habits.find((h) => h.id == habitId);

              // Update habit with new values from modal form
              habit.name = document.getElementById("edit-habit-name").value;
              habit.description = document.getElementById(
                "edit-habit-description"
              ).value;
              habit.startTime =
                document.getElementById("edit-start-time").value;
              habit.endTime = document.getElementById("edit-end-time").value;

              // Save updated habits and re-render the list
              this.saveHabits();
              this.renderHabits();
              this.updateDailyProgress();
              this.updateDonutCharts();

              // Close the modal
              const editModal = bootstrap.Modal.getInstance(
                document.getElementById("editHabitModal")
              );
              editModal.hide();
            });
        }

        updateDonutCharts() {
          const totalDayHours = 24;

          this.habits.forEach((habit) => {
            const donutChart = document.querySelector(
              `.donut-chart[data-habit-id="${habit.id}"]`
            );

            if (donutChart) {
              const startTime = new Date(`2000-01-01T${habit.startTime}`);
              const endTime = new Date(`2000-01-01T${habit.endTime}`);
              const habitHours = (endTime - startTime) / (1000 * 60 * 60);

              const percentage = Math.min(
                (habitHours / totalDayHours) * 100,
                100
              );

              // Update the donut chart
              const progressCircle = donutChart.querySelector(".progress");
              progressCircle.setAttribute(
                "stroke-dasharray",
                `${percentage} ${100 - percentage}`
              );

              // Update the text
              const centerText = donutChart.querySelector(".center-text");
              centerText.textContent = `${Math.round(percentage)}%`;

              // Update the color based on progress
              if (percentage < 33) {
                progressCircle.setAttribute("stroke", "green");
              } else if (percentage < 66) {
                progressCircle.setAttribute("stroke", "orange");
              } else {
                progressCircle.setAttribute("stroke", "red");
              }
            }
          });
        }

        resetForm() {
          document.getElementById("habit-name").value = "";
          document.getElementById("start-time").value = "";
          document.getElementById("end-time").value = "";
        }

        saveHabits() {
          const saveData = {
            startDate: this.startDate,
            habits: this.habits,
          };
          localStorage.setItem("habitData", JSON.stringify(saveData));
        }

        loadHabits() {
          const savedData = localStorage.getItem("habitData");
          if (savedData) {
            const { startDate, habits } = JSON.parse(savedData);
            this.startDate = new Date(startDate);
            document.getElementById("date-picker").value = this.startDate
              .toISOString()
              .split("T")[0];
            this.habits = habits;
            this.renderHabits();
          }
        }

        exportToPDF() {
          // Scroll to top before PDF export
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });

          const exportButton = document.getElementById("export-pdf");

          if (this.habits.length === 0) {
            alert("No habits to export!");
            return;
          }

          // Add a small delay to ensure smooth scrolling completes before PDF generation
          setTimeout(() => {
            // Add loading class for animation
            exportButton.classList.add("loading");

            // Create a main container for all pages
            const mainContainer = document.createElement("div");
            mainContainer.classList.add("pdf-export-container");

            // Calculate number of pages needed (6 habits per page)
            const habitsPerPage = 6;
            const totalPages = Math.ceil(this.habits.length / habitsPerPage);

            // Create pages
            for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
              // Create a page container
              const pageContainer = document.createElement("div");
              pageContainer.classList.add("pdf-page");
              pageContainer.style.display = "grid";
              pageContainer.style.gridTemplateColumns = "repeat(3, 1fr)";
              pageContainer.style.gridTemplateRows = "repeat(2, 1fr)";
              pageContainer.style.gap = "10px";
              pageContainer.style.padding = "10px";
              pageContainer.style.boxSizing = "border-box";
              pageContainer.style.pageBreakInside = "avoid";

              // Get habits for this page
              const startIndex = pageIndex * habitsPerPage;
              const endIndex = startIndex + habitsPerPage;
              const habitsForPage = this.habits.slice(startIndex, endIndex);

              // Clone and prepare habit containers for export
              habitsForPage.forEach((habit) => {
                const habitContainer = document.querySelector(
                  `.habit-container[data-habit-id="${habit.id}"]`
                );
                if (habitContainer) {
                  const clonedHabitContainer = habitContainer.cloneNode(true);

                  // Modify cloned container for PDF view
                  clonedHabitContainer.style.border = "1px solid #e0e0e0";
                  clonedHabitContainer.style.padding = "10px";
                  clonedHabitContainer.style.display = "flex";
                  clonedHabitContainer.style.flexDirection = "column";
                  clonedHabitContainer.style.height = "100%";

                  // Remove edit and delete icons for PDF
                  const actionIcons = clonedHabitContainer.querySelectorAll(
                    ".edit-habit, .delete-habit"
                  );
                  actionIcons.forEach((icon) => icon.remove());

                  pageContainer.appendChild(clonedHabitContainer);
                }
              });

              // Add page to main container
              mainContainer.appendChild(pageContainer);

              // Add page break after each page except the last one
              if (pageIndex < totalPages - 1) {
                const pageBreak = document.createElement("div");
                pageBreak.style.pageBreakAfter = "always";
                mainContainer.appendChild(pageBreak);
              }
            }

            const opt = {
              margin: [10, 10, 10, 10],
              filename: `habit-tracker-${
                new Date().toISOString().split("T")[0]
              }.pdf`,
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: {
                scale: 2,
                useCORS: true,
                logging: false,
                dpi: 300,
                windowWidth: document.documentElement.offsetWidth,
                windowHeight: document.documentElement.offsetHeight,
              },
              jsPDF: {
                unit: "mm",
                format: "a4",
                orientation: "landscape",
              },
            };

            // Temporarily add PDF container to body
            document.body.appendChild(mainContainer);

            html2pdf()
              .set(opt)
              .from(mainContainer)
              .save()
              .then(() => {
                // Remove the temporary PDF container
                document.body.removeChild(mainContainer);

                // Remove loading class and add success class
                exportButton.classList.remove("loading");
                exportButton.classList.add("success");

                // Reset button after a delay
                setTimeout(() => {
                  exportButton.classList.remove("success");
                }, 2000);
              })
              .catch((error) => {
                // Remove the temporary PDF container
                if (document.body.contains(mainContainer)) {
                  document.body.removeChild(mainContainer);
                }

                // Remove loading class if there's an error
                exportButton.classList.remove("loading");
                console.error("PDF Export Error:", error);
                alert("Error exporting PDF. Please try again.");
              });
          }, 1000);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        new HabitTracker();
      });
    </script>
  </body>
</html>
